---
title: "Epic 2.6 - UI Metrics Display: Real-Time Event Counts with Auto-Refresh"
status: "Ready for Development"
epic: "Epic 2: Event Processing & Storage + Metrics Display"
priority: "P1"
acceptance_criteria:
  - "Dashboard metrics panel displays total events count"
  - "Dashboard shows breakdown: pending, delivered, failed event counts"
  - "Pending count updates in real-time as events flow through system"
  - "Auto-refresh every 5 seconds (configurable)"
  - "Queue depth metric displayed"
  - "Dead Letter Queue count displayed"
  - "Last processed timestamp shown (ISO-8601 format)"
  - "Processing rate calculated and displayed (events per minute)"
  - "Metrics panel responsive layout (desktop and mobile)"
  - "Loading indicator shown while fetching metrics"
  - "Error state displays gracefully if metrics unavailable"
  - "Color indicators: pending (yellow), delivered (green), failed (red)"
  - "Statistics update without page reload"
  - "Network calls optimized: single /metrics endpoint request"
  - "Accessibility: ARIA labels and semantic HTML for metrics"
created_at: "2025-11-10"
modified_at: "2025-11-10"
story_size: "Large"
depends_on: "Epic 1.6 - UI Skeleton, Epic 2.5 - Metrics Updates"
---

## Summary

Build the real-time metrics dashboard panel that displays live event statistics. This provides visual confirmation that events are flowing through the system and shows current system state at a glance.

## Business Value

Provides visibility into system operation. Users can see event flow in real-time, identify bottlenecks, and confirm system health. Without visible metrics, the system appears to "do nothing."

## Technical Requirements

### Metrics Dashboard UI Component

**File Location:** `src/ui/components/MetricsDashboard.tsx`

**React Component Structure:**

```typescript
import React, { useEffect, useState, useCallback } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2, AlertCircle } from 'lucide-react';

interface MetricsData {
  total_events: number;
  pending: number;
  delivered: number;
  failed: number;
  queue_depth: number;
  dlq_count: number;
  last_processed_at: string | null;
  processing_rate: number;
}

interface MetricsStat {
  label: string;
  value: number;
  color: string;
  icon: React.ReactNode;
}

export const MetricsDashboard: React.FC = () => {
  const [metrics, setMetrics] = useState<MetricsData | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [lastUpdated, setLastUpdated] = useState<Date | null>(null);

  // Fetch metrics from API
  const fetchMetrics = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch('/metrics', {
        headers: {
          'Authorization': `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      setMetrics(data.data);
      setLastUpdated(new Date());
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Unknown error');
      console.error('Failed to fetch metrics:', err);
    } finally {
      setLoading(false);
    }
  }, []);

  // Auto-refresh every 5 seconds
  useEffect(() => {
    // Fetch immediately on mount
    fetchMetrics();

    // Set up interval for auto-refresh
    const interval = setInterval(fetchMetrics, 5000);

    return () => clearInterval(interval);
  }, [fetchMetrics]);

  if (error) {
    return (
      <Card className="bg-red-50 border-red-200">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-red-800">
            <AlertCircle className="w-5 h-5" />
            Metrics Unavailable
          </CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-red-700">{error}</p>
          <button
            onClick={fetchMetrics}
            className="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
          >
            Retry
          </button>
        </CardContent>
      </Card>
    );
  }

  if (!metrics) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Loader2 className="w-5 h-5 animate-spin" />
            Loading Metrics...
          </CardTitle>
        </CardHeader>
      </Card>
    );
  }

  const stats: MetricsStat[] = [
    {
      label: 'Total Events',
      value: metrics.total_events,
      color: 'bg-blue-100 text-blue-800',
      icon: 'ðŸ“Š',
    },
    {
      label: 'Pending',
      value: metrics.pending,
      color: 'bg-yellow-100 text-yellow-800',
      icon: 'â³',
    },
    {
      label: 'Delivered',
      value: metrics.delivered,
      color: 'bg-green-100 text-green-800',
      icon: 'âœ“',
    },
    {
      label: 'Failed',
      value: metrics.failed,
      color: 'bg-red-100 text-red-800',
      icon: 'âœ•',
    },
  ];

  const deliveryRate = metrics.total_events > 0
    ? Math.round((metrics.delivered / metrics.total_events) * 100)
    : 0;

  return (
    <div className="space-y-6">
      {/* Main Metrics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {stats.map((stat) => (
          <Card key={stat.label}>
            <CardContent className="pt-6">
              <div className={`p-4 rounded-lg ${stat.color} text-center`}>
                <div className="text-3xl font-bold">{stat.value}</div>
                <div className="text-sm font-medium mt-2">{stat.label}</div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* System Health and Queue Status */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Processing Status */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Processing Status</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">Queue Depth</span>
              <span className="text-lg font-bold text-blue-600">{metrics.queue_depth}</span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">Dead Letter Queue</span>
              <span className={`text-lg font-bold ${metrics.dlq_count > 0 ? 'text-red-600' : 'text-green-600'}`}>
                {metrics.dlq_count}
              </span>
            </div>
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">Processing Rate</span>
              <span className="text-lg font-bold text-purple-600">{metrics.processing_rate} evt/min</span>
            </div>
          </CardContent>
        </Card>

        {/* Delivery Analysis */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">Delivery Analysis</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex justify-between items-center">
              <span className="text-sm font-medium">Delivery Rate</span>
              <span className="text-lg font-bold text-green-600">{deliveryRate}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className="bg-green-600 h-2 rounded-full transition-all duration-300"
                style={{ width: `${deliveryRate}%` }}
                role="progressbar"
                aria-valuenow={deliveryRate}
                aria-valuemin={0}
                aria-valuemax={100}
              />
            </div>
            <div className="text-xs text-gray-600 mt-2">
              {metrics.last_processed_at
                ? `Last update: ${new Date(metrics.last_processed_at).toLocaleTimeString()}`
                : 'No events processed yet'}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Auto-refresh indicator */}
      <div className="text-xs text-gray-500 flex items-center justify-between">
        <span>
          Auto-refreshing every 5 seconds
          {lastUpdated && ` â€¢ Last updated ${lastUpdated.toLocaleTimeString()}`}
        </span>
        {loading && <Loader2 className="w-4 h-4 animate-spin" />}
      </div>
    </div>
  );
};

export default MetricsDashboard;

// Helper: Get auth token from localStorage
function getAuthToken(): string {
  return localStorage.getItem('auth_token') || '';
}
```

### Integration into Dashboard Layout

**Update:** `src/ui/App.tsx`

Add MetricsDashboard to main dashboard:

```typescript
import React, { useState } from 'react';
import { MetricsDashboard } from './components/MetricsDashboard';
import { EventInbox } from './components/EventInbox';
import { TailLogs } from './components/TailLogs';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

export const App: React.FC = () => {
  const [activeTab, setActiveTab] = useState('metrics');

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800">
      <header className="border-b border-slate-700 bg-slate-800/50 backdrop-blur">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <h1 className="text-3xl font-bold text-white">TriggersAPI Dashboard</h1>
          <p className="text-slate-400 mt-1">Real-time Event Ingestion & Processing</p>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-8">
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="metrics">Metrics</TabsTrigger>
            <TabsTrigger value="inbox">Event Inbox</TabsTrigger>
            <TabsTrigger value="logs">Tail Logs</TabsTrigger>
          </TabsList>

          <TabsContent value="metrics" className="mt-6">
            <MetricsDashboard />
          </TabsContent>

          <TabsContent value="inbox" className="mt-6">
            <EventInbox />
          </TabsContent>

          <TabsContent value="logs" className="mt-6">
            <TailLogs />
          </TabsContent>
        </Tabs>
      </main>
    </div>
  );
};

export default App;
```

### API Client Helper

**Update:** `src/ui/lib/api-client.ts`

Add metrics fetch utility:

```typescript
export interface ApiResponse<T> {
  data: T;
  timestamp: string;
}

export interface Metrics {
  total_events: number;
  pending: number;
  delivered: number;
  failed: number;
  queue_depth: number;
  dlq_count: number;
  last_processed_at: string | null;
  processing_rate: number;
}

export async function fetchMetrics(authToken: string): Promise<Metrics> {
  const response = await fetch('/metrics', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${authToken}`,
      'Content-Type': 'application/json',
    },
  });

  if (!response.ok) {
    throw new Error(`Failed to fetch metrics: HTTP ${response.status}`);
  }

  const data: ApiResponse<Metrics> = await response.json();
  return data.data;
}
```

### Styling with Tailwind

Metrics dashboard uses shadcn components styled with Tailwind CSS:

```typescript
// Card layouts
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">

// Color coding
bg-yellow-100 text-yellow-800  // Pending
bg-green-100 text-green-800     // Delivered
bg-red-100 text-red-800         // Failed
bg-blue-100 text-blue-800       // Total

// Responsive
flex-col md:flex-row
w-full md:w-1/2 lg:w-1/4

// Animations
animate-spin    // Loading indicator
transition-all  // Smooth updates
```

### Accessibility Features

**ARIA Attributes:**

```typescript
<div
  role="progressbar"
  aria-valuenow={deliveryRate}
  aria-valuemin={0}
  aria-valuemax={100}
  aria-label="Delivery rate progress"
/>
```

**Semantic HTML:**

```typescript
<Card aria-label="Metrics Dashboard">
  <CardTitle>Processing Status</CardTitle>
  <CardContent>
    {/* Structured content with proper heading hierarchy */}
  </CardContent>
</Card>
```

**Color + Text for Information:**

```typescript
// Not just color coded - include text labels
<span className="text-red-600">Failed: {metrics.failed}</span>
```

### Performance Optimization

**Efficient Updates:**

```typescript
// Only fetch metrics when needed (5s interval)
const interval = setInterval(fetchMetrics, 5000);

// Use useCallback to prevent unnecessary re-renders
const fetchMetrics = useCallback(async () => { ... }, []);

// Only update state if data changed
if (JSON.stringify(metrics) !== JSON.stringify(newMetrics)) {
  setMetrics(newMetrics);
}
```

**Network Optimization:**

```typescript
// Single endpoint request
GET /metrics

// Response includes all needed data
{
  "data": {
    "total_events": 100,
    "pending": 25,
    "delivered": 70,
    "failed": 5,
    ...
  }
}

// No overfetching or N+1 queries
```

### Testing Verification

**Manual Testing Steps:**

1. **Load Dashboard:**
   ```bash
   # Start Wrangler
   npx wrangler dev

   # Open browser: http://localhost:8787/
   # Metrics tab should load and display zeros initially
   ```

2. **Send Test Events:**
   ```bash
   # Send 10 events
   for i in {1..10}; do
     curl -X POST http://localhost:8787/events \
       -H "Authorization: Bearer test-token" \
       -H "Content-Type: application/json" \
       -d "{\"payload\":{\"id\":$i}}" &
   done
   wait
   ```

3. **Verify Auto-Refresh:**
   - Watch dashboard metrics update
   - Should see pending count increase to 10
   - Total events should show 10
   - Timestamp updates every 5 seconds

4. **Verify Responsive Layout:**
   - Desktop: 4 columns (Total, Pending, Delivered, Failed)
   - Tablet: 2 columns
   - Mobile: 1 column stack

5. **Error State Testing:**
   - Stop backend (should show error)
   - Verify retry button works
   - Verify error message is readable

6. **Loading State:**
   - Verify spinner shows while loading
   - Verify states transition smoothly

### Accessibility Testing

**Keyboard Navigation:**
- Tab through all interactive elements
- Verify focus visible on buttons
- Test tab order is logical

**Screen Reader:**
- ARIA labels readable
- Progress bar value announced
- Error messages announced
- Metrics labels clear

**Color Contrast:**
- All text meets WCAG AA (4.5:1 ratio)
- Not relying solely on color
- Red/green distinction alternative text

### Network Monitoring

**Check Metrics API:**
- DevTools Network tab
- Single GET /metrics request every 5 seconds
- Response size: ~200 bytes
- Response time: < 100ms
- Verify Authorization header sent

---

## Implementation Notes

### What Gets Done

1. Create `src/ui/components/MetricsDashboard.tsx` with React component
2. Update `src/ui/App.tsx` to include MetricsDashboard in main dashboard
3. Update `src/ui/lib/api-client.ts` with fetchMetrics() function
4. Implement auto-refresh interval (5 second default)
5. Add error state handling with retry
6. Add loading state with spinner
7. Implement color coding for status categories
8. Add progress bar for delivery rate visualization
9. Add responsive grid layout (1/2/4 columns)
10. Test locally: Send events and verify dashboard updates
11. Test accessibility: Keyboard nav, screen reader, contrast
12. Commit: `git add src/ui/ && git commit -m "feat: metrics dashboard UI with auto-refresh"`

### Development Workflow

1. Ensure metrics API endpoint (2.5) is working
2. Start: `npx wrangler dev`
3. Open http://localhost:8787/ in browser
4. Send test events and watch metrics update
5. Test auto-refresh (should update every 5 seconds)
6. Test responsive layout (resize window)
7. Test error handling (stop backend)
8. Check accessibility (keyboard nav, screen reader)

### Key Architecture Decisions

**Auto-Refresh Interval:** 5 seconds balances visibility with network load

**Single Endpoint:** GET /metrics returns all needed data (no N+1 fetching)

**Responsive Grid:** Adapts to screen size (1/2/4 columns)

**Color + Text:** Accessibility first (not just color coded)

---

## Acceptance Criteria Verification Checklist

### Metrics Display
- [ ] Total events count displayed prominently
- [ ] Pending count shown and updates in real-time
- [ ] Delivered count shown and updates
- [ ] Failed count shown and updates
- [ ] Queue depth displayed
- [ ] DLQ count displayed
- [ ] Last processed timestamp shown (ISO-8601)
- [ ] Processing rate displayed (events/minute)

### Auto-Refresh
- [ ] Metrics auto-refresh every 5 seconds
- [ ] No manual refresh required
- [ ] Interval can be configured
- [ ] Refresh cancels/stops on unmount
- [ ] Loading indicator shows during fetch

### Responsive Layout
- [ ] Desktop: 4-column grid for stat cards
- [ ] Tablet: 2-column layout
- [ ] Mobile: Single column stack
- [ ] No horizontal scrolling
- [ ] Touch-friendly button sizes (min 44x44px)

### Color Coding
- [ ] Pending: Yellow (#EAB308)
- [ ] Delivered: Green (#22C55E)
- [ ] Failed: Red (#EF4444)
- [ ] Total: Blue (#3B82F6)
- [ ] Queue: Purple (#A855F7)

### Error Handling
- [ ] Shows error message if metrics unavailable
- [ ] Retry button functional
- [ ] Graceful degradation (doesn't crash)
- [ ] Error color: Red background with white text

### Loading State
- [ ] Loading spinner shows while fetching
- [ ] Shows only on initial load
- [ ] Spinner continues during auto-refresh
- [ ] No skeleton loader needed (simple spinner OK)

### Accessibility
- [ ] All metrics have readable labels
- [ ] Progress bar has aria-valuenow, aria-valuemin, aria-valuemax
- [ ] Color not sole information indicator
- [ ] Text contrast meets WCAG AA (4.5:1)
- [ ] Keyboard navigable (Tab through elements)
- [ ] Error messages announced to screen readers

### Performance
- [ ] Single /metrics endpoint request (no N+1)
- [ ] Update without full page reload
- [ ] Smooth transitions (CSS animations)
- [ ] No janky re-renders
- [ ] Auto-refresh doesn't block UI

### Integration
- [ ] Metrics tab in dashboard navigation
- [ ] AuthToken passed in Authorization header
- [ ] API error codes handled
- [ ] Last updated timestamp accurate
- [ ] Metrics update when tab in focus

---

## Dependencies & Context

**From:** docs/PRD.md (Epic 2 section - Real-Time Metrics Display FR-5.2)
**Architecture:** docs/architecture.md (UI Performance section)
**Depends On:** Epic 1.6 (UI Skeleton), Epic 2.5 (Metrics API)
**Enables:** Epic 4 (Observability UI), Epic 5 (Debug Panel)

**UI Components:** shadcn/ui - Copy-paste component library
**Styling:** Tailwind CSS 3.x
**Icons:** lucide-react

---

## Dev Notes

- shadcn components are copy-paste - customize freely
- Auto-refresh interval configurable (change 5000ms to different value)
- Last updated timestamp shows when data was fetched
- Delivery rate calculated as (delivered / total) * 100
- Processing rate estimated from total and last timestamp
- DLQ count shows red if > 0 (indicates failures)
- Responsive layout uses Tailwind breakpoints (md, lg)
- All Metrics fields optional (use nullish coalescing for safety)

---

## Progressive Enhancement

**Phase 1 (MVP - This Story):**
- Static metrics display
- 5-second auto-refresh
- Basic cards and layout

**Phase 2 (Growth - Epic 4):**
- Chart visualization (latency distribution)
- More granular refresh rates
- Metrics history and trends

**Phase 3 (Future):**
- Real-time WebSocket updates
- Custom metrics alerts
- Historical metrics queries

---
