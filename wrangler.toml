# Cloudflare Workers Configuration
# Documentation: https://developers.cloudflare.com/workers/wrangler/configuration/

name = "triggers-api"
main = "src/index.ts"
compatibility_date = "2025-11-11"
compatibility_flags = ["nodejs_compat"]

workers_dev = false

[[routes]]
pattern = "triggers.adamwhite.work"
custom_domain = true

# Observability settings
[observability]
enabled = true

[observability.traces]
enabled = true

# D1 Database Binding
# Run: wrangler d1 create triggers-api
[[d1_databases]]
binding = "DB"
database_name = "triggers-api"
database_id = "66d5b9f6-4f3b-4512-a028-25816cf24554"
migrations_dir = "src/db/migrations"

# KV Binding for authentication tokens
[[kv_namespaces]]
binding = "AUTH_KV"
id = "5c4d6577b0754ed990e0ead4e88ecbb4"

# KV Binding for metrics tracking
[[kv_namespaces]]
binding = "METRICS_KV"
id = "5c4d6577b0754ed990e0ead4e88ecbb4"

# Queue Bindings
[[queues.producers]]
binding = "EVENT_QUEUE"
queue = "event-queue"

[[queues.consumers]]
queue = "event-queue"
max_batch_size = 100
max_batch_timeout = 1
max_retries = 3
dead_letter_queue = "event-dlq"
max_concurrency = 10

# Workflow Binding
# Epic 2.3: ProcessEventWorkflow for durable event processing
[[workflows]]
binding = "PROCESS_EVENT_WORKFLOW"
name = "process-event-workflow"
class_name = "ProcessEventWorkflow"
script_name = "triggers-api"

# Tail Worker Configuration
# Epic 4.1: Capture all Worker executions, logs, and metrics
[[tail_consumers]]
service = "triggers-api"

# Cron Triggers for Scheduled Tasks
# Epic 4.3: Metrics calculation every 30 seconds
[triggers]
crons = ["*/1 * * * *"]  # Every minute (Cloudflare minimum frequency)
